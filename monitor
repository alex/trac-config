import os
from twisted.application.service import Application
from twisted.application.internet import TimerService

application = Application('Trac Monitor')

from twisted.web.client import getPage
from twisted.internet.utils import getProcessValue
from twisted.python import log

def restart(f):
    log.err(f, "accessing trac.")
    log.msg("restarting trac."
    d = getProcessValue(os.path.expanduser("~/bin/restart"))
    d.addErrback(log.err, "restarting trac")

def check():
    d = getPage("http://localhost/trac", timeout=30)
    d.addErrback(restart)
    return d

TimerService(30, check).setServiceParent(application)
